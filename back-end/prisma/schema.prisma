// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model - Người dùng
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts            Account[]
  categories          Category[]
  transactions        Transaction[]
  budgets             Budget[]
  goals               Goal[]
  scheduledTransactions ScheduledTransaction[]
  debts               Debt[]

  @@map("users")
}

// Account Model - Tài khoản/Ví (Tiền mặt, Ngân hàng, Thẻ tín dụng, etc.)
model Account {
  id          String   @id @default(uuid())
  userId      String
  name        String
  type        AccountType
  balance     Decimal  @default(0) @db.Decimal(15, 2)
  currency    String   @default("VND")
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions          Transaction[]
  scheduledTransactions ScheduledTransaction[]
  debts                 Debt[]

  @@map("accounts")
}

enum AccountType {
  CASH          // Tiền mặt
  BANK          // Ngân hàng
  CREDIT_CARD   // Thẻ tín dụng
  SAVINGS       // Tài khoản tiết kiệm
  INVESTMENT    // Đầu tư
  OTHER         // Khác
}

// Category Model - Danh mục (Thu nhập, Chi tiêu)
model Category {
  id          String   @id @default(uuid())
  userId      String
  name        String
  type        CategoryType
  icon        String?
  color       String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions          Transaction[]
  budgets               Budget[]
  scheduledTransactions ScheduledTransaction[]

  @@map("categories")
}

enum CategoryType {
  INCOME   // Thu nhập
  EXPENSE  // Chi tiêu
}

// Transaction Model - Giao dịch (Thu nhập/Chi tiêu)
model Transaction {
  id          String   @id @default(uuid())
  userId      String
  accountId   String
  categoryId  String
  type        CategoryType
  amount      Decimal  @db.Decimal(15, 2)
  description String?
  date        DateTime @default(now())
  tags        String[] // Mảng các tag
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([accountId])
  @@index([categoryId])
  @@map("transactions")
}

// Budget Model - Ngân sách
model Budget {
  id          String   @id @default(uuid())
  userId      String
  categoryId  String
  amount      Decimal  @db.Decimal(15, 2)
  period      BudgetPeriod
  startDate   DateTime
  endDate     DateTime
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([userId, startDate, endDate])
  @@map("budgets")
}

enum BudgetPeriod {
  DAILY    // Hàng ngày
  WEEKLY   // Hàng tuần
  MONTHLY  // Hàng tháng
  YEARLY   // Hàng năm
}

// Goal Model - Mục tiêu tiết kiệm
model Goal {
  id          String   @id @default(uuid())
  userId      String
  name        String
  targetAmount Decimal @db.Decimal(15, 2)
  currentAmount Decimal @default(0) @db.Decimal(15, 2)
  targetDate  DateTime
  description String?
  isCompleted Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("goals")
}

// ScheduledTransaction Model - Giao dịch thanh toán theo thời gian (Lặp lại hoặc một lần)
model ScheduledTransaction {
  id              String   @id @default(uuid())
  userId          String
  accountId       String
  categoryId      String
  type            CategoryType
  amount          Decimal  @db.Decimal(15, 2)
  description     String?
  frequency       RecurrenceFrequency
  startDate       DateTime
  endDate         DateTime? // null = không có ngày kết thúc
  nextExecutionDate DateTime // Ngày thực hiện tiếp theo
  lastExecutionDate DateTime? // Ngày thực hiện lần cuối
  status          ScheduledTransactionStatus @default(ACTIVE)
  tags            String[] // Mảng các tag
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([userId, nextExecutionDate])
  @@index([status])
  @@map("scheduled_transactions")
}

enum RecurrenceFrequency {
  ONCE      // Một lần
  DAILY     // Hàng ngày
  WEEKLY    // Hàng tuần
  MONTHLY   // Hàng tháng
  YEARLY    // Hàng năm
  CUSTOM    // Tùy chỉnh (có thể mở rộng sau)
}

enum ScheduledTransactionStatus {
  ACTIVE    // Đang hoạt động
  PAUSED    // Tạm dừng
  COMPLETED // Đã hoàn thành
  CANCELLED // Đã hủy
}

// Debt Model - Nợ tài khoản (Mình nợ người khác hoặc người khác nợ mình)
model Debt {
  id              String   @id @default(uuid())
  userId          String
  type            DebtType
  creditorName    String   // Tên người cho vay (nếu mình nợ) hoặc người nợ (nếu người khác nợ mình)
  originalAmount  Decimal  @db.Decimal(15, 2) // Số tiền ban đầu
  currentAmount   Decimal  @db.Decimal(15, 2) // Số tiền còn lại
  interestRate    Decimal? @db.Decimal(5, 2) // Lãi suất (%)
  startDate       DateTime // Ngày vay/cho vay
  dueDate         DateTime? // Ngày đáo hạn
  description     String?
  status          DebtStatus @default(ACTIVE)
  accountId       String? // Tài khoản liên quan (nếu có)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account?    @relation(fields: [accountId], references: [id], onDelete: SetNull)
  payments DebtPayment[]

  @@index([userId, status])
  @@index([dueDate])
  @@map("debts")
}

enum DebtType {
  BORROWED  // Mình nợ người khác (Debt - Nợ phải trả)
  LENT      // Người khác nợ mình (Credit - Khoản phải thu)
}

enum DebtStatus {
  ACTIVE    // Đang nợ
  PAID      // Đã trả hết
  OVERDUE   // Quá hạn
  CANCELLED // Đã hủy
}

// DebtPayment Model - Lịch sử thanh toán nợ
model DebtPayment {
  id          String   @id @default(uuid())
  debtId      String
  amount      Decimal  @db.Decimal(15, 2) // Số tiền thanh toán
  paymentDate DateTime @default(now())
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  debt Debt @relation(fields: [debtId], references: [id], onDelete: Cascade)

  @@index([debtId, paymentDate])
  @@map("debt_payments")
}
